<div class="w-full h-16 bg-gray-900 px-4 flex justify-between items-center shadow-lg text-white">
    <!-- Left Group: Brand, File, Edit -->
    <div class="flex items-center space-x-4">
        <h1 class="text-xl font-bold text-cyan-400">DarrowArt</h1>
        
        <!-- File Actions -->
        <div class="flex items-center space-x-1 bg-gray-800 p-1 rounded-lg">
            <button title="New Canvas" (click)="stateService.showNewCanvasModal()" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </button>
            <button title="Resize Canvas" (click)="stateService.showResizeCanvasModal()" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path d="M6.13 1L6 16a2 2 0 0 0 2 2h15"></path>
                  <path d="M1 6.13L16 6a2 2 0 0 1 2 2v15"></path>
                </svg>
            </button>
            <button title="Import Image" (click)="onImportClick()" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            </button>
            <button title="Generate Image" (click)="stateService.showGenerateImageModal()" class="p-2 bg-purple-600 hover:bg-purple-500 rounded-lg transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M6.672 1.911a1 1 0 10-1.343 1.482l.064.075 1.152 1.305-.16 1.72-1.428 1.428a1 1 0 000 1.414l4.242 4.242a1 1 0 001.414 0l1.428-1.428 1.72-.16 1.305 1.152a1 1 0 101.482-1.343l-.075-.064-1.305-1.152.16-1.72 1.428-1.428a1 1 0 000-1.414L13.33 3.636a1 1 0 00-1.414 0L10.5 5.064l-1.72.16-1.152-1.305-.064-.075zm-3.28 7.352a1 1 0 00-1.414 1.414l1.667 1.667a1 1 0 101.414-1.414l-1.667-1.667zM8.5 6.5a1 1 0 10-1.414-1.414L5.419 6.753a1 1 0 101.414 1.414L8.5 6.5z" clip-rule="evenodd" />
                </svg>
            </button>
            <button title="Download" (click)="stateService.triggerDownload()" class="p-2 bg-green-600 hover:bg-green-500 rounded-lg transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
            </button>
        </div>
        
        <!-- History Actions -->
        <div class="flex items-center space-x-1 bg-gray-800 p-1 rounded-lg">
            <button title="Undo" (click)="stateService.triggerUndo()" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <button title="Redo" (click)="stateService.triggerRedo()" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Center Group: Tools & Settings -->
    <div class="flex items-center space-x-4">
        <!-- Tools -->
        <div class="flex items-center space-x-1 p-1 bg-gray-800 rounded-lg">
            <div class="relative" (mouseenter)="handleMenuEnter('brush')" (mouseleave)="handleMenuLeave()">
                <button
                    title="Brush"
                    (click)="stateService.setTool('brush')"
                    [class]="stateService.activeTool() === 'brush' ? 'bg-cyan-500 text-white' : 'bg-gray-700 hover:bg-gray-600'"
                    class="p-2 rounded-lg transition-colors duration-200 relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" />
                    </svg>
                    <div class="absolute bottom-0 right-0 p-px bg-gray-800 bg-opacity-50 rounded-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-2 w-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </button>
                <div 
                    class="absolute top-full left-0 mt-2 z-10 w-72 bg-gray-800 rounded-lg shadow-xl p-2 space-y-1 transition-opacity duration-200 ease-in-out"
                    [class.opacity-100]="openFlyout() === 'brush'"
                    [class.opacity-0]="openFlyout() !== 'brush'"
                    [class.invisible]="openFlyout() !== 'brush'">
                    @for(brush of stateService.brushes(); track brush.id) {
                      <div (click)="selectBrush(brush.id)" 
                           class="p-2 rounded-lg cursor-pointer flex items-center space-x-3 transition-colors"
                           [class]="brush.id === stateService.activeBrush()?.id ? 'bg-gray-700' : 'bg-transparent hover:bg-gray-700'">
                        
                        <div class="w-10 h-10 bg-gray-900 rounded flex items-center justify-center flex-shrink-0">
                          @if (isCustomBrush(brush)) {
                            <img [src]="brush.shape.texture" alt="Brush texture" class="max-w-full max-h-full" style="filter: invert(1);">
                          } @else {
                            @switch (brush.id) {
                              @case ('round') { <div class="w-6 h-6 bg-white rounded-full"></div> }
                              @case ('calligraphy') { <div class="w-6 h-1.5 bg-white rounded-sm" style="transform: rotate(-45deg);"></div> }
                              @case ('charcoal') { 
                                <svg width="24" height="24" viewBox="0 0 100 100"><defs><filter id="f"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="5" stitchTiles="stitch"/></filter></defs><rect width="100" height="100" filter="url(#f)" fill="#fff"/></svg>
                              }
                              @case ('spray') { <div class="w-6 h-6 rounded-full border-2 border-dashed border-white"></div> }
                            }
                          }
                        </div>

                        <div class="flex-grow w-0 flex items-center justify-between">
                          <span class="font-semibold truncate block text-sm text-white">{{ brush.name }}</span>
                          @if (isCustomBrush(brush)) {
                            <div class="flex items-center space-x-1 flex-shrink-0">
                              <button title="Duplicate Brush" (click)="duplicateBrush($event, brush)" class="p-1 rounded-md text-gray-400 hover:text-white hover:bg-gray-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                              </button>
                              <button title="Edit Brush" (click)="editBrush($event, brush.id)" class="p-1 rounded-md text-gray-400 hover:text-white hover:bg-gray-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                </svg>
                              </button>
                              <button title="Delete Brush" (click)="deleteBrush($event, brush.id)" class="p-1 rounded-md text-gray-400 hover:text-white hover:bg-red-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                              </button>
                            </div>
                          }
                        </div>
                      </div>
                    }
                    <div class="border-t border-gray-700 my-1"></div>
                    <button (click)="openBrushStudio()" class="w-full text-left px-3 py-2 text-sm rounded-md hover:bg-gray-700 transition-colors text-white flex items-center space-x-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span>Brush Studio</span>
                    </button>
                </div>
            </div>
             <button
                title="Smudge"
                (click)="stateService.setTool('smudge')"
                [class]="stateService.activeTool() === 'smudge' ? 'bg-cyan-500 text-white' : 'bg-gray-700 hover:bg-gray-600'"
                class="p-2 rounded-lg transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2c-4.42 0-8 3.58-8 8 0 4.08 3.06 7.44 7 7.93V22h2v-4.07c3.94-.49 7-3.85 7-7.93 0-4.42-3.58-8-8-8z"/>
                </svg>
            </button>
            <div class="relative" (mouseenter)="handleMenuEnter('eraser')" (mouseleave)="handleMenuLeave()">
                <button
                    title="Eraser"
                    (click)="stateService.setTool('eraser')"
                    [class]="stateService.activeTool() === 'eraser' ? 'bg-cyan-500 text-white' : 'bg-gray-700 hover:bg-gray-600'"
                    class="p-2 rounded-lg transition-colors duration-200 relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.53,6.53,17.47,4.47a.75.75,0,0,0-1.06,0L11,9.88,6.59,5.47a.75.75,0,0,0-1.06,1.06L9.88,11,5.47,15.41a.75.75,0,0,0,1.06,1.06L11,12.12l4.41,4.41a.75.75,0,0,0,1.06-1.06L12.12,11,l5.41-5.41A.75.75,0,0,0,19.53,6.53Z" transform="rotate(45 12 12)"/>
                        <path d="M20.25,8.5h-5.5l-2,2,2,2h5.5a2,2,0,0,0,2-2v-0A2,2,0,0,0,20.25,8.5Z" transform="rotate(45 12 12)"/>
                    </svg>
                    <div class="absolute bottom-0 right-0 p-px bg-gray-800 bg-opacity-50 rounded-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-2 w-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </button>
                <div
                    class="absolute top-full left-0 mt-2 z-10 w-40 bg-gray-800 rounded-lg shadow-xl p-2 space-y-1 transition-opacity duration-200 ease-in-out"
                    [class.opacity-100]="openFlyout() === 'eraser'"
                    [class.opacity-0]="openFlyout() !== 'eraser'"
                    [class.invisible]="openFlyout() !== 'eraser'">
                    @for(eraser of stateService.erasers(); track eraser.id) {
                        <button (click)="selectEraser(eraser.id)" class="w-full text-left px-3 py-2 text-sm rounded-md hover:bg-gray-700 transition-colors"
                            [class]="stateService.activeEraser()?.id === eraser.id ? 'text-cyan-400 font-semibold' : 'text-white'">
                            {{ eraser.name }}
                        </button>
                    }
                </div>
            </div>
            <button
                title="Pan Tool"
                (click)="stateService.setTool('pan')"
                [class]="stateService.activeTool() === 'pan' ? 'bg-cyan-500 text-white' : 'bg-gray-700 hover:bg-gray-600'"
                class="p-2 rounded-lg transition-colors duration-200">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.6,12.65a1,1,0,0,0-.85.3,1,1,0,0,1-1.25.36,1,1,0,0,0-1.14.26L15.5,14.5a1,1,0,0,0,0,1.41,1,1,0,0,0,.71.29,1,1,0,0,0,.7-.29l1-1a1,1,0,0,1,1.41,0,1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41l-1.17-1.17A1,1,0,0,0,19.6,12.65Zm-3.46,1.46L15.5,13.47a1,1,0,0,0-1.41,0L11,16.59V13a1,1,0,0,0-2,0v6a1,1,0,0,0,1,1,1,1,0,0,0,.71-.29l3.18-3.18a1,1,0,0,0,0-1.41ZM7.5,10.5a1,1,0,0,0,1.41,0l3.18-3.18a1,1,0,0,0,0-1.41,1,1,0,0,0-1.41,0L10,6.59V3a1,1,0,0,0-2,0V8.59L4.93,5.51a1,1,0,0,0-1.41,1.41L7,10.29A1,1,0,0,0,7.5,10.5Z"/>
                </svg>
            </button>
            <button
                title="Text Tool"
                (click)="stateService.setTool('text')"
                [class]="stateService.activeTool() === 'text' ? 'bg-cyan-500 text-white' : 'bg-gray-700 hover:bg-gray-600'"
                class="p-2 rounded-lg transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7V4h16v3M9 20h6M12 4v16" />
                </svg>
            </button>
            <button
                title="Eyedropper"
                (click)="stateService.setTool('eyedropper')"
                [class]="stateService.activeTool() === 'eyedropper' ? 'bg-cyan-500 text-white' : 'bg-gray-700 hover:bg-gray-600'"
                class="p-2 rounded-lg transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M20.57,9.43A1,1,0,0,0,20,9H15a1,1,0,0,0,0,2h2.59L13,15.59l-3.29-3.3a1,1,0,0,0-1.42,0L3.71,16.88A1,1,0,0,0,3,18H9a1,1,0,0,0,0-2H5.41L9,12.41l3.29,3.3a1,1,0,0,0,1.42,0L19,10.41V13a1,1,0,0,0,2,0V10A1,1,0,0,0,20.57,9.43Z" transform="rotate(-45 12 12)"/>
                </svg>
            </button>
        </div>
        
        <!-- Color Picker -->
        <div class="relative h-10 w-10">
            <label for="colorPicker"
                class="block w-full h-full rounded-full border-2 border-gray-500 cursor-pointer"
                [style.background]="stateService.brushColor()"></label>
            <input id="colorPicker" type="color" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer" [value]="stateService.brushColor()" (input)="handleColorChange($event)">
        </div>

        <!-- Contextual Settings -->
        @if (stateService.activeTool() === 'brush' || stateService.activeTool() === 'eraser') {
          <div class="flex items-center space-x-2 text-sm">
              <label for="brushSize" class="text-gray-400">Size:</label>
              <input
                  id="brushSize"
                  type="range"
                  min="1"
                  max="200"
                  class="w-32 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                  [value]="stateService.brushSize()"
                  (input)="handleSizeChange($event)">
              <span class="font-mono w-8 text-center">{{ stateService.brushSize() }}</span>
          </div>
        }
        @if (stateService.activeTool() === 'smudge') {
          <div class="flex items-center space-x-4 text-sm">
            <div class="flex items-center space-x-2">
              <label for="smudgeSize" class="text-gray-400">Size:</label>
              <input
                  id="smudgeSize"
                  type="range"
                  min="1"
                  max="200"
                  class="w-24 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                  [value]="stateService.brushSize()"
                  (input)="handleSizeChange($event)">
              <span class="font-mono w-8 text-center">{{ stateService.brushSize() }}</span>
            </div>
             <div class="flex items-center space-x-2">
              <label for="smudgeStrength" class="text-gray-400">Strength:</label>
              <input
                  id="smudgeStrength"
                  type="range"
                  min="1"
                  max="100"
                  class="w-24 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                  [value]="stateService.smudgeStrength()"
                  (input)="handleSmudgeStrengthChange($event)">
              <span class="font-mono w-8 text-center">{{ stateService.smudgeStrength() }}</span>
            </div>
          </div>
        }
        @if (stateService.activeTool() === 'text') {
          <div class="flex items-center space-x-4 text-sm">
            <div class="flex items-center space-x-2">
                <label for="fontSize" class="text-gray-400">Size:</label>
                <input
                    id="fontSize"
                    type="range"
                    min="8"
                    max="128"
                    class="w-24 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                    [value]="stateService.fontSize()"
                    (input)="handleFontSizeChange($event)">
                <span class="font-mono w-8 text-center">{{ stateService.fontSize() }}</span>
            </div>
            <div class="flex items-center space-x-2">
                 <label for="fontFamily" class="text-gray-400">Font:</label>
                <select id="fontFamily" 
                    class="bg-gray-700 text-white text-xs rounded p-1 border border-gray-600 w-28"
                    [value]="stateService.fontFamily()"
                    (change)="handleFontFamilyChange($event)">
                  @for(font of fonts; track font) {
                    <option [value]="font">{{ font }}</option>
                  }
                </select>
            </div>
          </div>
        }
    </div>

    <!-- Right Group: Guides & View -->
    <div class="flex items-center space-x-2">
         <div class="flex items-center space-x-1 bg-gray-800 p-1 rounded-lg">
             <div class="relative" (mouseenter)="handleMenuEnter('guides')" (mouseleave)="handleMenuLeave()">
                <button
                    title="Guides"
                    [class]="stateService.symmetryMode() !== 'none' || stateService.isGridVisible() ? 'bg-cyan-500 text-white' : 'bg-gray-700 hover:bg-gray-600'"
                    class="p-2 rounded-lg transition-colors duration-200 w-full relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v18" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.929 4.929C2.183 7.675 1 11.691 1 12c0 .309.183 4.325 3.929 7.071" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.071 4.929C21.817 7.675 23 11.691 23 12c0 .309-.183 4.325-3.929 7.071" />
                    </svg>
                    <div class="absolute bottom-0 right-0 p-px bg-gray-800 bg-opacity-50 rounded-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-2 w-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </button>
                <div 
                    class="absolute top-full right-0 mt-2 z-10 w-64 bg-gray-800 rounded-lg shadow-xl p-2 space-y-1 transition-opacity duration-200 ease-in-out"
                    [class.opacity-100]="openFlyout() === 'guides'"
                    [class.opacity-0]="openFlyout() !== 'guides'"
                    [class.invisible]="openFlyout() !== 'guides'">
                     <h4 class="px-3 pt-2 pb-1 text-xs font-bold text-gray-400 uppercase">Symmetry</h4>
                     <button (click)="selectSymmetryMode('none')" class="w-full text-left px-3 py-2 text-sm rounded-md hover:bg-gray-700 transition-colors" [class]="stateService.symmetryMode() === 'none' ? 'text-cyan-400 font-semibold' : 'text-white'">None</button>
                     <button (click)="selectSymmetryMode('vertical')" class="w-full text-left px-3 py-2 text-sm rounded-md hover:bg-gray-700 transition-colors" [class]="stateService.symmetryMode() === 'vertical' ? 'text-cyan-400 font-semibold' : 'text-white'">Vertical</button>
                     <button (click)="selectSymmetryMode('horizontal')" class="w-full text-left px-3 py-2 text-sm rounded-md hover:bg-gray-700 transition-colors" [class]="stateService.symmetryMode() === 'horizontal' ? 'text-cyan-400 font-semibold' : 'text-white'">Horizontal</button>
                     <button (click)="selectSymmetryMode('radial')" class="w-full text-left px-3 py-2 text-sm rounded-md hover:bg-gray-700 transition-colors" [class]="stateService.symmetryMode() === 'radial' ? 'text-cyan-400 font-semibold' : 'text-white'">Radial</button>
                    @if (stateService.symmetryMode() === 'radial') {
                        <div class="px-3 py-1">
                            <label for="radialSegments" class="text-xs text-gray-400 mb-1 block">Segments: <span class="font-mono">{{ stateService.radialSegments() }}</span></label>
                            <input
                                id="radialSegments"
                                type="range"
                                min="2"
                                max="36"
                                step="1"
                                class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer"
                                [value]="stateService.radialSegments()"
                                (input)="handleRadialSegmentsChange($event)">
                        </div>
                    }
                    <div class="border-t border-gray-700 my-2"></div>
                    <h4 class="px-3 pt-2 pb-1 text-xs font-bold text-gray-400 uppercase">Drawing Aids</h4>
                    <button (click)="stateService.isQuickShapeEnabled.set(!stateService.isQuickShapeEnabled())" class="w-full text-left px-3 py-2 text-sm rounded-md hover:bg-gray-700 transition-colors flex justify-between items-center" [class]="stateService.isQuickShapeEnabled() ? 'text-cyan-400 font-semibold' : 'text-white'">
                        <span>Quick Shape</span>
                        <div class="w-4 h-4 rounded border-2 flex items-center justify-center" [class]="stateService.isQuickShapeEnabled() ? 'border-cyan-400 bg-cyan-500' : 'border-gray-500'">
                            @if(stateService.isQuickShapeEnabled()){ <div class="w-2 h-2 bg-white rounded-sm"></div> }
                        </div>
                    </button>
                    <button (click)="stateService.toggleGridVisibility()" class="w-full text-left px-3 py-2 text-sm rounded-md hover:bg-gray-700 transition-colors flex justify-between items-center" [class]="stateService.isGridVisible() ? 'text-cyan-400 font-semibold' : 'text-white'">
                        <span>Show Grid</span>
                        <div class="w-4 h-4 rounded border-2 flex items-center justify-center" [class]="stateService.isGridVisible() ? 'border-cyan-400 bg-cyan-500' : 'border-gray-500'">
                            @if(stateService.isGridVisible()){ <div class="w-2 h-2 bg-white rounded-sm"></div> }
                        </div>
                    </button>
                    @if (stateService.isGridVisible()) {
                        <div class="px-3 py-1 space-y-2">
                             <div>
                                <label for="gridSize" class="text-xs text-gray-400 mb-1 block">Size: <span class="font-mono">{{ stateService.gridSize() }}</span></label>
                                <input
                                    id="gridSize"
                                    type="range"
                                    min="10"
                                    max="200"
                                    step="5"
                                    class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer"
                                    [value]="stateService.gridSize()"
                                    (input)="handleGridSizeChange($event)">
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="gridColor" class="text-xs text-gray-400">Grid Color</label>
                                <input id="gridColor" type="color" class="p-0 h-6 w-10 bg-gray-600 rounded cursor-pointer" [value]="stateService.gridColor()" (input)="handleGridColorChange($event)">
                            </div>
                        </div>
                    }
                    <div class="border-t border-gray-700 my-2"></div>
                    <h4 class="px-3 pt-2 pb-1 text-xs font-bold text-gray-400 uppercase">Canvas</h4>
                    <div class="px-3 py-1">
                        <div class="flex items-center justify-between">
                            <label for="bgColor" class="text-sm text-white">Background</label>
                            <input id="bgColor" type="color" class="p-0 h-6 w-10 bg-gray-600 rounded cursor-pointer" [value]="stateService.backgroundColor()" (input)="handleBgColorChange($event)">
                        </div>
                    </div>
                </div>
            </div>
            <button title="Toggle Layers" (click)="stateService.toggleLayersPanel()" 
                [class]="stateService.isLayersPanelVisible() ? 'bg-cyan-500 text-white' : 'bg-gray-700 hover:bg-gray-600'"
                class="p-2 rounded-lg transition-colors duration-200">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
                </svg>
            </button>
            <button title="Clear Canvas" (click)="stateService.triggerClear()" class="p-2 bg-gray-700 hover:bg-red-500 rounded-lg transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
         </div>
    </div>

    <input type="file" #fileInput class="hidden" (change)="onFileSelected($event)" accept="image/*">
</div>